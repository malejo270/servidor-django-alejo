{% extends "base.html" %}
{% block content %}

<h2>Revisi贸n de Subestaci贸n: {{ subestacion.nombre }} - {{ categoria|title }}</h2>

<style>
    .form-section { margin-bottom: 20px; padding: 12px; border: 1px solid #ccc; border-radius: 8px; background: #f9f9f9; }
    .form-section h3 { margin-bottom: 10px; font-size: 15px; color: #2c3e50; cursor: pointer; }
    .sub-section { margin-left: 20px; padding: 10px; border-left: 2px solid #aaa; margin-bottom: 10px; }
    .sub-section h4 { font-size: 14px; margin-bottom: 8px; color: #34495e; cursor: pointer; }
    .field-group { display: flex; flex-direction: column; margin-bottom: 10px; }
    .field-group label { font-size: 13px; margin-bottom: 3px; }
    .field-group input, .field-group select, .field-group textarea {
        padding: 6px; font-size: 13px; border: 1px solid #ccc; border-radius: 4px; width: 100%;
    }
    .hidden { display: none; }
    .no-components { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin: 20px 0; }
    .info-message { background: #d1ecf1; border: 1px solid #bee5eb; padding: 15px; border-radius: 5px; margin: 20px 0; }
    .observaciones-header { background: #e8f5e8; border: 1px solid #c8e6c9; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    @media (min-width: 768px) {
        .field-row { display: flex; gap: 10px; }
        .field-row .field-group { flex: 1; }
    }
</style>

<form method="post">
    {% csrf_token %}

    {% if es_observaciones %}
    <div class="observaciones-header">
        <h3> Observaciones Generales</h3>
        <p>Complete las observaciones generales para la subestaci贸n <strong>{{ subestacion.nombre }}</strong></p>
    </div>
    {% endif %}

    {% if not hay_componentes and not es_observaciones %}
    <div class="no-components">
        <h3>锔 No se encontraron componentes</h3>
        <p>No hay componentes de tipo <strong>{{ tipo_componente }}</strong> en la subestaci贸n <strong>{{ subestacion.nombre }}</strong>.</p>
        <p>Por favor, verifique la configuraci贸n de componentes en la subestaci贸n.</p>
    </div>
    {% endif %}

    {% for comp_data in componentes_con_preguntas %}
    <div class="form-section">
        {% if es_observaciones %}
        <h3 class="toggle-componente" style="background: #4caf50; color: white; padding: 10px; border-radius: 5px;">
             {{ comp_data.componente.nombre_componente }}
        </h3>
        {% else %}
        <h3 class="toggle-componente">{{ comp_data.componente.nombre_componente }} ({{ comp_data.componente.get_tipo_display }})</h3>
        {% endif %}
        
        <div class="componente-content {% if not hay_componentes and not es_observaciones %}hidden{% endif %}">
            
            {# Preguntas SIN padre #}
            {% for pregunta_data in comp_data.preguntas_sin_padre %}
            <div class="field-group">
                <label for="{{ pregunta_data.key }}">
                    {% if es_observaciones %}
                    <strong>{{ pregunta_data.pregunta.texto }}</strong>
                    {% else %}
                    {{ pregunta_data.pregunta.texto }}
                    {% endif %}
                </label>
                {% if pregunta_data.pregunta.tipo == "texto" %}
                    {% if es_observaciones %}
                    <textarea name="{{ pregunta_data.key }}" id="{{ pregunta_data.key }}" rows="3" placeholder="Ingrese su observaci贸n...">{{ pregunta_data.valor }}</textarea>
                    {% else %}
                    <input type="text" name="{{ pregunta_data.key }}" id="{{ pregunta_data.key }}" value="{{ pregunta_data.valor }}" placeholder="Ingrese su respuesta...">
                    {% endif %}
                {% else %}
                    <select name="{{ pregunta_data.key }}" id="{{ pregunta_data.key }}">
                        <option value="">--- Seleccione ---</option>
                        <option value="Bien" {% if pregunta_data.valor == "Bien" %}selected{% endif %}>Bien</option>
                        <option value="Mal" {% if pregunta_data.valor == "Mal" %}selected{% endif %}>Mal</option>
                    </select>
                {% endif %}
            </div>
            {% endfor %}

            {# Preguntas CON padre #}
            {% for padre_key, padre_data in comp_data.preguntas_con_padre.items %}
            <div class="sub-section">
                <h4 class="toggle-padre">
                    {% if es_observaciones %}
                     {{ padre_data.padre.texto }}
                    {% else %}
                    {{ padre_data.padre.texto }}
                    {% endif %}
                </h4>
                <div class="padre-content {% if not es_observaciones %}hidden{% endif %}">
                    <div class="field-row">
                        {% for pregunta_data in padre_data.preguntas %}
                        <div class="field-group">
                            <label for="{{ pregunta_data.key }}">
                                {% if es_observaciones %}
                                <strong>{{ pregunta_data.pregunta.texto }}</strong>
                                {% else %}
                                {{ pregunta_data.pregunta.texto }}
                                {% endif %}
                            </label>
                            {% if pregunta_data.pregunta.tipo == "texto" %}
                                {% if es_observaciones %}
                                <textarea name="{{ pregunta_data.key }}" id="{{ pregunta_data.key }}" rows="3" placeholder="Ingrese su observaci贸n...">{{ pregunta_data.valor }}</textarea>
                                {% else %}
                                <input type="text" name="{{ pregunta_data.key }}" id="{{ pregunta_data.key }}" value="{{ pregunta_data.valor }}" placeholder="Ingrese su respuesta...">
                                {% endif %}
                            {% else %}
                                <select name="{{ pregunta_data.key }}" id="{{ pregunta_data.key }}">
                                    <option value="">--- Seleccione ---</option>
                                    <option value="Bien" {% if pregunta_data.valor == "Bien" %}selected{% endif %}>Bien</option>
                                    <option value="Mal" {% if pregunta_data.valor == "Mal" %}selected{% endif %}>Mal</option>
                                </select>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}

    

    <div style="text-align:center; margin-top:15px;">
        <button type="submit" style="padding:10px 20px; background:#2ecc71; color:white; border:none; border-radius:6px; font-size:14px;">
            {% if es_observaciones %}
             Guardar Observaciones
            {% else %}
            Guardar Revisiones
            {% endif %}
        </button>
        
        <a href="{% url 'seleccionar_reporte' orden.id_orden %}" 
           style="padding:10px 20px; background:#95a5a6; color:white; border:none; border-radius:6px; font-size:14px; text-decoration:none; margin-left:10px;">
            ╋ Volver a Selecci贸n
        </a>
    </div>
</form>

<script>
    document.querySelectorAll('.toggle-componente').forEach(h3 => {
        h3.addEventListener('click', () => {
            const content = h3.nextElementSibling;
            content.classList.toggle('hidden');
        });
    });

    document.querySelectorAll('.toggle-padre').forEach(h4 => {
        h4.addEventListener('click', () => {
            const content = h4.nextElementSibling;
            content.classList.toggle('hidden');
        });
    });

    // Expandir autom谩ticamente secciones que tienen valores
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.form-section').forEach(section => {
            const inputs = section.querySelectorAll('input, select, textarea');
            let hasValues = false;
            
            inputs.forEach(input => {
                if (input.value && input.value.trim() !== '') {
                    hasValues = true;
                }
            });
            
            if (hasValues) {
                const content = section.querySelector('.componente-content');
                if (content) content.classList.remove('hidden');
                
                // Tambi茅n expandir las secciones de padre con valores
                section.querySelectorAll('.padre-content').forEach(padreContent => {
                    const padreInputs = padreContent.querySelectorAll('input, select, textarea');
                    let padreHasValues = false;
                    
                    padreInputs.forEach(input => {
                        if (input.value && input.value.trim() !== '') {
                            padreHasValues = true;
                        }
                    });
                    
                    if (padreHasValues) {
                        padreContent.classList.remove('hidden');
                    }
                });
            }
        });

        // Para observaciones, expandir todo autom谩ticamente
        {% if es_observaciones %}
        document.querySelectorAll('.componente-content').forEach(content => {
            content.classList.remove('hidden');
        });
        
        document.querySelectorAll('.padre-content').forEach(content => {
            content.classList.remove('hidden');
        });
        {% endif %}
    });

    // Auto-expandir secciones al enfocar un campo
    document.addEventListener('focus', function(e) {
        if (e.target.matches('input, select, textarea')) {
            const componenteContent = e.target.closest('.componente-content');
            if (componenteContent && componenteContent.classList.contains('hidden')) {
                componenteContent.classList.remove('hidden');
            }
            
            const padreContent = e.target.closest('.padre-content');
            if (padreContent && padreContent.classList.contains('hidden')) {
                padreContent.classList.remove('hidden');
            }
        }
    }, true);
</script>

{% endblock %}
