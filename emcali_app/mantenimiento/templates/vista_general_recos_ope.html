{% extends 'base.html' %}
{% block content %}

<div class="container my-4">

    <h2 class="text-center text-danger mb-4">Vista General de Recos</h2>

    <!-- Bot√≥n volver -->
    <div class="mb-3">
        <a href="{% url 'lista_ordenes' %}" class="btn fw-bold"
           style="background-color:#ffcc00; color:#000;">
            ‚Üê Volver
        </a>
    </div>

    <!-- Controles superiores -->
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">

        <!-- Bot√≥n filtros -->
        <button onclick="toggleFiltro()" class="btn fw-bold"
                style="background-color:#ffcc00; color:#000;">
            üîΩ Filtros
        </button>

        <!-- Buscador -->
        <div class="d-flex align-items-center gap-2">
            <input type="text" id="buscador" class="form-control"
                   placeholder="Buscar por nodo..." style="max-width:230px;">
            <button onclick="buscar()" class="btn btn-primary px-3">Buscar</button>
            <a href="{% url 'vista_general_recos' %}"
               class="fs-4 text-secondary text-decoration-none" title="Recargar">
                üîÑ
            </a>
        </div>

    </div>

    <!-- Filtro por tecnolog√≠a -->
    <div id="filtroTecnologia" class="p-3 border rounded mb-3" style="display:none;">
        <strong>Filtrar por tecnolog√≠a:</strong>

        <div class="row mt-2">
            <div class="col-6 col-md-3"><label><input type="checkbox" class="filtro-tec" value="Vac√≠as" checked> (Vac√≠as)</label></div>
            <div class="col-6 col-md-3"><label><input type="checkbox" class="filtro-tec" value="204" checked> 204</label></div>
            <div class="col-6 col-md-3"><label><input type="checkbox" class="filtro-tec" value="ADSL" checked> ADSL</label></div>
            <div class="col-6 col-md-3"><label><input type="checkbox" class="filtro-tec" value="FIBRA" checked> FIBRA</label></div>

            <div class="col-6 col-md-3 mt-2"><label><input type="checkbox" class="filtro-tec" value="N/A" checked> N/A</label></div>
            <div class="col-6 col-md-3 mt-2"><label><input type="checkbox" class="filtro-tec" value="NA" checked> NA</label></div>
            <div class="col-6 col-md-3 mt-2"><label><input type="checkbox" class="filtro-tec" value="TIGO" checked> TIGO</label></div>
            <div class="col-6 col-md-3 mt-2"><label><input type="checkbox" class="filtro-tec" value="UMTS" checked> UMTS</label></div>
            <div class="col-6 col-md-3 mt-2"><label><input type="checkbox" class="filtro-tec" value="WOM" checked> WOM</label></div>
        </div>
    </div>

    <!-- Tabla -->
    <div class="table-responsive">
        <table id="tabla" class="table table-bordered table-sm align-middle text-center">
            <thead style="background-color:#ffcc00; color:black;">
                <tr>
                    <th>Nodo</th>
                    <th>Marca Reconectador</th>
                    <th>Tecnolog√≠a modem</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>

                {% for nodo in nodos %}
                {% for reco in nodo.reconectador_set.all %}
                {% for comunicacion in reco.comunicacion_set.all %}
                <tr>

                    <td>{{ nodo.nodo }}</td>
                    <td>{{ reco.marca }}</td>
                    <td>{{ comunicacion.tecnologia }}</td>

                    <!-- ACCIONES (CORREGIDO PARA CELULAR) -->
                    <td class="text-center">
                        <div class="d-flex flex-column flex-md-row justify-content-center gap-2">

                            <a href="{% url 'lista_recos_comunicaciones' nodo.id_nodo %}?from=vista_general_recos_ope"
                               class="btn btn-sm"
                               style="background-color:#1abc9c; color:white;">
                                Ver
                            </a>

                            {% if comunicacion.id_comunicacion %}
                                <a href="{% url 'historico_trabajos' comunicacion.id_comunicacion %}"
                                   class="btn btn-sm"
                                   style="background-color:#6c5ce7; color:white;">
                                    Hist√≥rico
                                </a>
                            {% else %}
                                <span class="btn btn-sm disabled"
                                      style="background-color:#ccc; color:white;">
                                    Hist√≥rico
                                </span>
                            {% endif %}

                        </div>
                    </td>

                </tr>
                {% endfor %}
                {% endfor %}
                {% empty %}
                <tr>
                    <td colspan="4" class="text-center py-3">No hay datos disponibles.</td>
                </tr>
                {% endfor %}

            </tbody>
        </table>
    </div>

</div>


<script>
function toggleFiltro() {
    const filtro = document.getElementById("filtroTecnologia");
    filtro.style.display = (filtro.style.display === "none" || filtro.style.display === "") ? "block" : "none";
}

// Filtrar por texto
function buscar() {
    const input = document.getElementById("buscador").value.toLowerCase();
    const filas = document.querySelectorAll("#tabla tbody tr");

    filas.forEach(function(fila) {
        const nodo = fila.cells[0].textContent.toLowerCase();
        fila.style.display = nodo.includes(input) ? "" : "none";
    });
}

// Filtrar tecnolog√≠a
document.querySelectorAll(".filtro-tec").forEach(function(checkbox) {
    checkbox.addEventListener("change", filtrarTecnologia);
});

function filtrarTecnologia() {
    const seleccionadas = Array.from(document.querySelectorAll(".filtro-tec:checked")).map(cb => cb.value.toLowerCase());
    const filas = document.querySelectorAll("#tabla tbody tr");

    filas.forEach(function(fila) {
        const tecnologia = fila.cells[2].textContent.toLowerCase().trim();
        fila.style.display =
            seleccionadas.includes(tecnologia) ||
            (tecnologia === "" && seleccionadas.includes("vac√≠as"))
            ? ""
            : "none";
    });
}
</script>

{% endblock %}
