{% extends 'base.html' %}

{% block content %}
<div style="max-width: 700px; margin: 40px auto; font-family: Arial, sans-serif;">

    <!-- Bot√≥n de volver -->
    <div style="margin-bottom: 20px;">
        <a href="{% url 'lista_ordenes' %}"
           style="background-color: #ffcc00; color: #000; padding: 8px 16px; text-decoration: none;
                  border-radius: 4px; font-weight: bold; display: inline-block;">
            ‚Üê Volver
        </a>
    </div>

    <h2 style="color: #d00000; text-align: center; margin-bottom: 30px;">
        üö® Reporte de Emergencia
    </h2>

    <form id="form-reco" method="post" enctype="multipart/form-data"
          style="background: #fff; padding: 30px 40px; border-left: 6px solid #ffcc00;
                 box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); border-radius: 8px;">
        {% csrf_token %}

        {% if messages %}
        <div style="margin-bottom: 20px;">
            {% for message in messages %}
                {% if message.tags == 'error' %}
                    <div style="padding:10px; border-radius:5px; margin-bottom:10px;
                                background-color:#f8d7da; color:#721c24;">
                        {{ message }}
                    </div>
                {% elif message.tags == 'success' %}
                    <div style="padding:10px; border-radius:5px; margin-bottom:10px;
                                background-color:#d4edda; color:#155724;">
                        {{ message }}
                    </div>
                {% else %}
                    <div style="padding:10px; border-radius:5px; margin-bottom:10px;
                                background-color:#e2e3e5; color:#41464b;">
                        {{ message }}
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        {% endif %}

        <!-- Tipo de reporte -->
        <div style="margin-bottom: 20px;">
            <label for="tipo" style="font-weight: bold;">Tipo de Reporte:</label>
            <select name="tipo" id="tipo" required
                    style="width: 100%; padding: 8px; border-radius: 4px;
                           border: 1px solid #ccc; margin-top:6px;">
                <option value="">-- Selecciona el tipo --</option>
                <option value="subestacion">Subestaci√≥n</option>
                <option value="reco">Reconectador</option>
            </select>
        </div>

        <!-- Nodo / Subestaci√≥n -->
        <div id="seccion-nodo" style="display:none; margin-bottom: 20px;">
            <label for="nodo_nombre" id="label_nodo" style="font-weight: bold;"></label>

            <input name="nodo_nombre" id="nodo_nombre" placeholder=""
                   list=""
                   style="width: 100%; padding: 8px; margin-top: 6px;
                          border: 1px solid #ccc; border-radius: 4px;">

            <datalist id="lista_nodos">
                {% for nodo in nodos %}
                    <option value="{{ nodo.nodo }}"></option>
                {% endfor %}
            </datalist>

            <datalist id="lista_subestaciones">
                {% for sub in subestaciones %}
                    <option value="{{ sub.nombre }}"></option>
                {% endfor %}
            </datalist>
        </div>

        <!-- SECCI√ìN RECO -->
        <div id="seccion-reco" style="display:none; margin-top: 10px;">

            <div style="margin-bottom: 20px;">
                <label style="font-weight: bold;">Falla Identificada:</label>
                <select id="falla_identificada" name="falla_identificada"
                        style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                    <option value="">-- Selecciona una falla --</option>
                    <option value="falta_tension_ac">Falta tensi√≥n AC</option>
                    <option value="modem_apagado">Modem apagado</option>
                    <option value="display_no_prende">Display no prende</option>
                    <option value="breaker_abierto">Breaker AC abierto</option>
                    <option value="fuente_dc_apagada">Fuente DC apagada</option>
                    <option value="caja_bloqueada">Caja de control bloqueada</option>
                    <option value="falta_antena">Falta antena</option>
                    <option value="antena_caida">Antena ca√≠da</option>
                    <option value="modem_no_comunica">Modem no comunica</option>
                    <option value="falla_fibra">Falla en fibra √≥ptica</option>
                    <option value="desconocida">Desconocida</option>
                </select>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="font-weight: bold;">Causa de la Falla:</label>
                <textarea id="causa_falla" name="causa_falla"
                          style="width: 100%; padding: 8px; border-radius: 4px;
                                 border: 1px solid #ccc;"></textarea>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="font-weight: bold;">Trabajo Realizado:</label>
                <textarea id="trabajo_realizado" name="trabajo_realizado"
                          style="width: 100%; padding: 8px; border-radius: 4px;
                                 border: 1px solid #ccc;"></textarea>
            </div>

            <!-- TELCO -->
            <div style="margin-bottom: 15px;">
                <label style="font-weight: bold;">Aviso a TELCO:</label>
                <input type="checkbox" id="aviso_telco" name="aviso_telco" style="margin-left: 8px;">
            </div>

            <div id="detalle_telco_container" class="d-none" style="margin-bottom: 20px;">
                <label style="font-weight: bold;">Detalle Telco:</label>
                <textarea name="detalle_telco"
                          style="width: 100%; padding: 8px; border-radius: 4px;
                                 border: 1px solid #ccc;"></textarea>
            </div>

            <!-- MANTENIMIENTO -->
            <div style="margin-bottom: 15px;">
                <label style="font-weight: bold;">Aviso a Mantenimiento:</label>
                <input type="checkbox" id="aviso_mante" name="aviso_mante" style="margin-left: 8px;">
            </div>

            <div id="detalle_mante_container" class="d-none" style="margin-bottom: 20px;">
                <label style="font-weight: bold;">Detalle Mantenimiento:</label>
                <textarea name="detalle_mante"
                          style="width: 100%; padding: 8px; border-radius: 4px;
                                 border: 1px solid #ccc;"></textarea>
            </div>

            <!-- FOTOS -->
            <div style="margin-bottom: 20px;">
                <label style="font-weight: bold;">Fotos (m√°ximo 3):</label>

                <div class="border p-2 rounded mt-2">
                    <input type="file" name="foto1" accept="image/*">
                </div>

                <div class="border p-2 rounded mt-2">
                    <input type="file" name="foto2" accept="image/*">
                </div>

                <div class="border p-2 rounded mt-2">
                    <input type="file" name="foto3" accept="image/*">
                </div>

            </div>

        </div>

        <!-- SECCI√ìN SUBESTACI√ìN -->
        <div id="seccion-sub" style="display:none; margin-top: 10px;">

            <div style="margin-bottom: 20px;">
                <label style="font-weight: bold;">Trabajo realizado (Comunicaciones Subestaci√≥n):</label>
                <textarea id="trabajo_realizado_sub_comu" name="trabajo_realizado_sub_comu"
                          style="width: 100%; padding: 8px; border-radius: 4px;
                                 border: 1px solid #ccc;"></textarea>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="font-weight: bold;">Otras observaciones:</label>
                <textarea id="otras_observaciones" name="otras_observaciones"
                          style="width: 100%; padding: 8px; border-radius: 4px;
                                 border: 1px solid #ccc;"></textarea>
            </div>

        </div>

        <!-- Coordenadas -->
        <input type="hidden" id="latitud" name="latitud">
        <input type="hidden" id="longitud" name="longitud">

        <button id="btn-guardar" type="submit"
                style="display:none; width: 100%; background-color: #d00000; color: white; padding: 12px;
                       font-weight: bold; border: none; border-radius: 5px; font-size: 16px;">
            Guardar Reporte
        </button>

    </form>
</div>

<script>
/* ----------------------------
   MOSTRAR / OCULTAR SECCIONES
------------------------------ */
document.addEventListener('DOMContentLoaded', function () {

    const tipoSelect = document.getElementById('tipo');
    const inputNodo = document.getElementById('nodo_nombre');
    const labelNodo = document.getElementById('label_nodo');

    const seccionNodo = document.getElementById('seccion-nodo');
    const seccionReco = document.getElementById('seccion-reco');
    const seccionSub = document.getElementById('seccion-sub');
    const btnGuardar = document.getElementById('btn-guardar');

    function onTipoChange() {
        const val = tipoSelect.value;

        if (val === "subestacion") {
            seccionNodo.style.display = "block";
            labelNodo.textContent = "Seleccione la Subestaci√≥n:";
            inputNodo.setAttribute("list", "lista_subestaciones");
            seccionSub.style.display = "block";
            seccionReco.style.display = "none";
            btnGuardar.style.display = "block";
        }

        else if (val === "reco") {
            seccionNodo.style.display = "block";
            labelNodo.textContent = "Seleccione el Nodo:";
            inputNodo.setAttribute("list", "lista_nodos");
            seccionSub.style.display = "none";
            seccionReco.style.display = "block";
            btnGuardar.style.display = "block";
        }

        else {
            seccionNodo.style.display = "none";
            inputNodo.removeAttribute("list");
            seccionSub.style.display = "none";
            seccionReco.style.display = "none";
            btnGuardar.style.display = "none";
        }
    }

    tipoSelect.addEventListener('change', onTipoChange);
    onTipoChange();

    getLocation();
});

/* ----------------------------
     GPS AUTOM√ÅTICO
------------------------------ */
function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function (position) {
                document.getElementById('latitud').value = position.coords.latitude.toFixed(7);
                document.getElementById('longitud').value = position.coords.longitude.toFixed(7);
            },
            function (error) {
                console.warn("No se pudo obtener ubicaci√≥n: " + error.message);
            }
        );
    }
}


/* -----------------------------------------------------
   üî• AQUI AGREGO COMPLETO TU SCRIPT ADAPTADO A TU HTML
------------------------------------------------------ */
document.addEventListener("DOMContentLoaded", () => {

    const form = document.getElementById('form-reco');
    const btnGuardar = document.getElementById('btn-guardar');
    const latInput = document.getElementById('latitud');
    const lonInput = document.getElementById('longitud');

    /* ---- GEO ---- */
    function inicializarGeolocalizacion() {
        if (btnGuardar) btnGuardar.disabled = false;

        if (navigator.geolocation && (!latInput.value || !lonInput.value)) {

            navigator.geolocation.getCurrentPosition(
                pos => {
                    latInput.value = pos.coords.latitude.toFixed(6);
                    lonInput.value = pos.coords.longitude.toFixed(6);
                },
                err => {
                    console.warn("Ubicaci√≥n no disponible:", err);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        }
    }

    /* ---- TELCO / MANTE ---- */
    function inicializarControlesDinamicos() {

        const avisoTelco = document.getElementById("aviso_telco");
        const detalleTelco = document.getElementById("detalle_telco_container");
        const avisoMante = document.getElementById("aviso_mante");
        const detalleMante = document.getElementById("detalle_mante_container");

        function toggleDetalle(checkbox, contenedor) {
            if (!checkbox || !contenedor) return;

            contenedor.classList.toggle("d-none", !checkbox.checked);

            const textarea = contenedor.querySelector("textarea");
            if (textarea) textarea.required = checkbox.checked;
        }

        if (avisoTelco) {
            avisoTelco.addEventListener("change", () => toggleDetalle(avisoTelco, detalleTelco));
            toggleDetalle(avisoTelco, detalleTelco);
        }

        if (avisoMante) {
            avisoMante.addEventListener("change", () => toggleDetalle(avisoMante, detalleMante));
            toggleDetalle(avisoMante, detalleMante);
        }
    }

    /* ---- AUTOGUARDADO ---- */
    function inicializarAutoGuardado() {

        const storageKey = "formRecoData_emergencia";

        form.querySelectorAll("input, textarea, select").forEach(field => {

            if (field.type === "file") return;

            field.addEventListener("input", () => {
                const formData = new FormData(form);
                const data = {};

                for (let [key, value] of formData.entries()) {
                    if (form.querySelector(`[name="${key}"]`).type !== "file") {
                        data[key] = value;
                    }
                }

                form.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    data[cb.name] = cb.checked;
                });

                localStorage.setItem(storageKey, JSON.stringify(data));
            });

        });

        window.addEventListener("load", () => {

            const savedData = localStorage.getItem(storageKey);
            if (!savedData) return;

            try {
                const data = JSON.parse(savedData);

                for (let name in data) {
                    const field = form.querySelector(`[name="${name}"]`);
                    if (!field) continue;

                    if (field.type === "checkbox") {
                        field.checked = data[name];
                        field.dispatchEvent(new Event("change"));
                    } else {
                        field.value = data[name];
                    }
                }

            } catch (e) {
                console.error("Error cargando datos:", e);
            }
        });

        form.addEventListener("submit", () => {
            latInput.value = latInput.value.replace(",", ".");
            lonInput.value = lonInput.value.replace(",", ".");
            localStorage.removeItem(storageKey);
        });
    }

    /* ---- PREVIEW FOTOS ---- */
    function inicializarVistaPreviaImagenes() {
        const contenedores = document.querySelectorAll('.border');

        contenedores.forEach(container => {
            const input = container.querySelector('input[type="file"]');

            input.addEventListener("change", e => {

                let previewDiv = container.querySelector(".preview-div");
                if (!previewDiv) {
                    previewDiv = document.createElement("div");
                    previewDiv.classList.add("preview-div", "position-relative", "mt-2");
                    container.appendChild(previewDiv);
                }

                previewDiv.innerHTML = "";

                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (ev) {

                    const img = document.createElement("img");
                    img.src = ev.target.result;
                    img.classList.add("img-fluid", "rounded");
                    img.style.maxHeight = "150px";

                    const removeBtn = document.createElement("button");
                    removeBtn.innerHTML = "‚úñ";
                    removeBtn.type = "button";
                    removeBtn.classList.add("btn", "btn-danger", "btn-sm", "position-absolute");
                    removeBtn.style.top = "5px";
                    removeBtn.style.right = "5px";
                    removeBtn.style.borderRadius = "50%";

                    removeBtn.onclick = () => {
                        input.value = "";
                        previewDiv.innerHTML = "";
                    };

                    previewDiv.appendChild(img);
                    previewDiv.appendChild(removeBtn);
                };

                reader.readAsDataURL(file);
            });

        });
    }

    /* ---- Inicializar TODO ---- */
    inicializarGeolocalizacion();
    inicializarControlesDinamicos();
    inicializarAutoGuardado();
    inicializarVistaPreviaImagenes();

});
</script>

{% endblock %}
