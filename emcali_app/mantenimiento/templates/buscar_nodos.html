{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h1>Buscar Nodos</h1>

    <!-- Formulario de b煤squeda con AUTOCOMPLETAR -->
    <div class="search-box mt-3">
        <form method="GET">
            <div class="input-group">

                <input list="lista_nodos"
                       name="q"
                       value="{{ query }}"
                       class="form-control"
                       placeholder="Escribe un nodo o direcci贸n...">

                <datalist id="lista_nodos">
                    {% for n in nodos_lista %}
                        <option value="{{ n.nodo }}">
                    {% endfor %}
                </datalist>

                <button type="submit" class="btn btn-primary">Buscar</button>
            </div>
        </form>
    </div>

    <!-- Resultados -->
    {% if nodos %}
        <h3 class="mt-4">Resultados para "{{ query }}":</h3>

        {% for nodo in nodos %}
            <div class="card nodo-card mt-3">
                <div class="card-body">

                    <h5 class="card-title">{{ nodo.nodo }}</h5>
                    <p class="card-text"><strong>Direcci贸n:</strong> {{ nodo.direccion }}</p>
                    <p class="card-text"><strong>Subestaci贸n:</strong> {{ nodo.id_subestacion }}</p>

                    {% if nodo.circuito1 %}
                        <p class="card-text"><strong>Circuito 1:</strong> {{ nodo.circuito1 }}</p>
                    {% endif %}

                    {% if nodo.circuito2 %}
                        <p class="card-text"><strong>Circuito 2:</strong> {{ nodo.circuito2 }}</p>
                    {% endif %}

                    <!-- Coordenadas -->
                    <div class="coordenadas mt-3">
                        <p class="mb-1"><strong>Coordenadas:</strong></p>
                        <p class="mb-1">Latitud: {{ nodo.latitud_processed|default:"No disponible" }}</p>
                        <p class="mb-1">Longitud: {{ nodo.longitud_processed|default:"No disponible" }}</p>
                    </div>

                    <!-- Bot贸n ruta -->
                    {% if nodo.latitud_processed and nodo.longitud_processed %}
                        <button class="btn btn-success mt-3 btn-ruta"
                                data-lat="{{ nodo.latitud_processed }}"
                                data-lon="{{ nodo.longitud_processed }}">
                             Ver Ruta en Google Maps
                        </button>
                    {% else %}
                        <p class="text-muted mt-2">Coordenadas no disponibles para ruta</p>
                    {% endif %}
                </div>
            </div>
        {% endfor %}

    {% elif query %}
        <div class="alert alert-warning mt-4" role="alert">
            No se encontraron nodos para "{{ query }}"
        </div>
    {% endif %}
</div>

<!-- SCRIPT RUTAS -->
<script>
document.addEventListener('DOMContentLoaded', function() {

    const botonesRuta = document.querySelectorAll('.btn-ruta');

    botonesRuta.forEach(btn => {
        btn.addEventListener('click', function() {

            const latNodo = this.getAttribute('data-lat');
            const lonNodo = this.getAttribute('data-lon');

            if (!navigator.geolocation) {
                alert("La geolocalizaci贸n no es soportada por este navegador.");
                return;
            }

            const original = this.innerHTML;
            this.innerHTML = ' Obteniendo ubicaci贸n...';
            this.disabled = true;

            navigator.geolocation.getCurrentPosition(

                (pos) => {
                    const url = `https://www.google.com/maps/dir/${pos.coords.latitude},${pos.coords.longitude}/${latNodo},${lonNodo}`;

                    this.innerHTML = original;
                    this.disabled = false;

                    window.open(url, "_blank");
                },

                (error) => {
                    this.innerHTML = original;
                    this.disabled = false;

                    if (error.code === error.PERMISSION_DENIED) {
                        alert("Permiso de ubicaci贸n denegado. Activa el GPS.");
                    } else {
                        alert("No se pudo obtener tu ubicaci贸n.");
                    }
                },

                { timeout: 10000, enableHighAccuracy: true }
            );
        });
    });
});
</script>

<!-- ESTILOS -->
<style>
.nodo-card {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    transition: box-shadow 0.2s;
}
.nodo-card:hover {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}
.coordenadas {
    color: #6c757d;
    font-size: 0.9rem;
    background-color: #f8f9fa;
    padding: 10px;
    border-radius: 0.25rem;
}
.btn-ruta {
    transition: all 0.2s;
}
.btn-ruta:hover {
    transform: translateY(-1px);
}
.search-box .input-group {
    max-width: 500px;
}
</style>

{% endblock %}
